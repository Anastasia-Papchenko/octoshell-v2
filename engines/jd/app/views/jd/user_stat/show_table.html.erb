<div class="navbar-fixed-top col-xs-2 return-btn-container"></div>

<p id="notice"><%= notice %></p>

<script type="text/javascript">
  $(document).ready(function() {
      var start_date = <% if @t_from %> new Date(<%= @t_from * 1000 %>); <% else %> new Date(2016, 1, 7); <% end %>
      var end_date = <% if @t_to %> new Date(<%= @t_to * 1000 %>); <% else %> new Date(); <% end %>

      $("#request_start_date").datepicker({format: 'yyyy-mm-dd'});
      $("#request_start_date").datepicker("setDate", start_date);

      $("#request_end_date").datepicker({format: 'yyyy-mm-dd'});
      $("#request_end_date").datepicker("setDate", end_date);
  });
</script>

<%= form_for "request", url: "/jd/job_stat" do |f| %>
    <% @available_projects.each do |project, accounts| %>
      <h2>Project: <%= project.title %></h2>
      <table border="1" width="100%">

        <% accounts.each_with_index do |account, index| %>

          <% if index % 5 == 0 %>
            <tr>
          <% end %>
            <td style="padding: 5px 10px; width: 20%">
              <div class="text_field">
                <%= check_box_tag "selected_accounts[]", account, @allowed_accounts.include?(account) %>
                <%= f.label account %>
              </div>
            </td>
          <% if index % 5 == 5 %>
            </tr>
          <% end %>
      <% end %>
      </table>
      <div style="margin-top: 20px; "></div>
    <% end %>

    <table>
      <tr>
        <div>
          <td>
            <%= f.label :start_date%>
          </td>
          <td>
            <%= f.text_field :start_date %>
          </td>
        </div>
      </tr>

      <tr>
        <div>
          <td>
            <%= f.label :end_date%>
          </td>
          <td>
            <%= f.text_field :end_date %>
          </td>
        </div>
      </tr>
    </table>

    <div style="margin-top: 20px; "></div>

    <div class="submit">
      <%= f.submit "Show" %>
    </div>
<% end %>

<% if not @user_stat.nil? %>
    <h1>Total</h1>

    <table id="general_table" class="tablesorter-blue task_table">
      <thead>
        <tr>
          <th>System</th>
          <th>Total tasks</th>
          <th>Total CPU*Hours</th>
          <th>Total GPU*Hours</th>
        </tr>
      </thead>

      <tbody>
        <% @system_stat.each do |name, stat| %>
          <tr>
            <td class="table_text"><%= name %></td>
            <td class="sensor_text"><%= stat["count"] %></td>
            <td class="sensor_text"><%= stat["cores_sec"] / 3600 %></td>
            <td class="sensor_text"><%= stat["gpu_sec"] / 3600 %></td>
          </tr>
        <% end %>
      </tbody>
    </table>

  <% @systems.each do |system_name, _| %>
    <h1><%= system_name %></h1>

    <table id="tasks_table" class="tablesorter-blue task_table">
      <thead>
        <tr>
          <th>Partition</th>
          <th>State</th>
          <th>Count</th>
          <th>Cores*Hours</th>
        </tr>
      </thead>

      <tbody>
        <% @user_stat[system_name]["count"].each do |partition, states| %>
          <tr>
            <td class="table_bold_text" rowspan="<%= states.length + 1 %>"class="table_text"><%= partition %></td>

            <td class="table_bold_text">TOTAL</td>
            <td class="table_bold_text sensor_text"> <%= states.values.reduce(:+) %> </td>
            <td class="table_bold_text sensor_text"> <%= format_float_or_nil(@user_stat[system_name]["cores_sec"][partition].values.reduce(:+) / 3600.0) %> </td>
          </tr>
          <% states.each do |state, count| %>
            <tr>
              <td class="table_text"><%= state %></td>
              <td class="sensor_text"><%= count %></td>
              <td class="sensor_text"><%= format_float_or_nil(@user_stat[system_name]["cores_sec"][partition][state] / 3600.0) %></td>
            </tr>
          <% end %>
        <% end %>
      </tbody>
    </table>
  <% end %>
<% end %>
